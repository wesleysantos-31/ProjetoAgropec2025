<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGROPEC 2025 - Event App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.4.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F5; /* Cinza Claro */
            color: #424242; /* Cinza Escuro */
        }
        .sidebar {
            background-color: #388E3C; /* Verde Secund√°rio */
            color: #FFFFFF; /* Branco */
        }
        .sidebar a {
            color: #FFFFFF;
            transition: background-color 0.3s ease;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: #4CAF50; /* Verde Principal */
        }
        .main-content section {
            display: none;
        }
        .main-content section.active {
            display: block;
        }
        .btn-primary {
            background-color: #4CAF50; /* Verde Principal */
            color: #FFFFFF;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #388E3C; /* Verde Secund√°rio */
        }
        .btn-accent {
            background-color: #FFC107; /* Dourado/Amarelo */
            color: #424242;
            transition: background-color 0.3s ease;
        }
        .btn-accent:hover {
            background-color: #FFA000; /* Dourado/Amarelo mais escuro */
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for charts */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px; /* Max height */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        h1, h2, h3 {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }
        .agropec-logo-text {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: #4CAF50;
            padding: 0.5rem 1rem;
            border: 2px solid #4CAF50;
            border-radius: 0.25rem;
            display: inline-block;
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #F5F5F5; /* Cinza Claro */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4CAF50; /* Verde Principal */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #388E3C; /* Verde Secund√°rio */
        }

        /* Nova classe para esconder a sidebar inicialmente e ao deslogar */
        .sidebar-initial-hidden {
            display: none;
        }

        /* Estilos para o canvas do mapa */
        .map-canvas { /* Classe geral para ambos os mapas */
            border: 1px solid #ccc;
            /* REMOVIDO: background-color: #e0ffe0; */
            cursor: crosshair;
            width: 100%; /* Garante que o canvas seja responsivo */
            height: 400px; /* Altura fixa para o mapa */
            display: block;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
        }
        /* Estilos para o modal de QR Code */
        .qr-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .qr-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 80%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }
        .qr-modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
        }
        .qr-modal-close:hover,
        .qr-modal-close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="sidebar w-16 md:w-64 space-y-6 py-7 px-2 md:px-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out sidebar-initial-hidden">
        <div class="px-4 py-2 flex items-center justify-center md:justify-start">
            <img src="https://placehold.co/40x40/FFFFFF/388E3C?text=A&font=Inter" alt="AGROPEC Logo Icon" class="h-10 w-10 md:hidden">
            <span class="agropec-logo-text hidden md:block">AGROPEC</span>
        </div>

        <nav class="mt-10">
            <a href="#login" onclick="window.showSection('login', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h5a3 3 0 013 3v1"></path></svg>
                <span class="hidden md:inline">Login</span>
            </a>
            <a href="#inicio" onclick="window.showSection('inicio', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                <span class="hidden md:inline">In√≠cio</span>
            </a>
            <a href="#agenda" onclick="window.showSection('agenda', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span class="hidden md:inline">Agenda</span>
            </a>
            <a href="#expositores" onclick="window.showSection('expositores', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                <span class="hidden md:inline">Expositores</span>
            </a>
            <a href="#mapa" onclick="window.showSection('mapa', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13v-6m0 6l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 13v-6m0 6l-6-3"></path></svg>
                <span class="hidden md:inline">Mapa</span>
            </a>
            <a href="#admin-dashboard" id="admin-dashboard-link" onclick="window.showSection('admin-dashboard', this)" class="nav-link flex items-center py-2.5 px-4 rounded transition duration-200 hover:bg-green-700 hidden">
                <svg class="w-6 h-6 mr-0 md:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.562.344 1.25.513 1.943.513z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="hidden md:inline">Painel Administrativo</span>
            </a>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white shadow-md p-4 flex items-center justify-between">
            <button id="mobileMenuButton" class="md:hidden mr-4 text-gray-600 hover:text-green-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 id="currentSectionTitle" class="text-2xl font-semibold text-gray-700">Bem-vindo!</h1>
            <div class="flex items-center">
                <div id="user-id-display" class="text-sm text-gray-500 hidden md:block mr-4"></div>
                <button id="logout-button" class="btn-accent text-sm py-1 px-3 rounded-md hidden">Sair</button>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6 main-content">
            <section id="welcome-role-selection" class="p-6 active">
                <div class="max-w-md mx-auto card p-8 text-center">
                    <div class="flex justify-center mb-8">
                         <img src="https://placehold.co/200x100/4CAF50/FFFFFF?text=AGROPEC+2025&font=Inter" alt="AGROPEC 2025 Logo" class="h-auto">
                    </div>
                    <h2 class="text-3xl font-bold text-center mb-2 text-green-600">Bem-vindo!</h2>
                    <p class="text-center text-gray-600 mb-8">Eu sou</p>
                    <button type="button" id="visitor-button" class="w-full btn-primary font-semibold py-3 px-4 rounded-md text-lg mb-4">Visitante</button>
                    <button type="button" id="admin-button" class="w-full btn-accent font-semibold py-3 px-4 rounded-md text-lg">Administrador</button>
                </div>
            </section>

            <section id="login" class="p-6">
                <div class="max-w-md mx-auto card p-8">
                    <div class="flex justify-center mb-8">
                         <img src="https://placehold.co/200x100/4CAF50/FFFFFF?text=AGROPEC+2025&font=Inter" alt="AGROPEC 2025 Logo" class="h-auto">
                    </div>
                    <h2 class="text-3xl font-bold text-center mb-2 text-green-600">Acesse sua conta</h2>
                    <p class="text-center text-gray-600 mb-8">Para explorar o evento AGROPEC.</p>
                    <form>
                        <div class="mb-4">
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">E-mail</label>
                            <input type="email" id="email" name="email" placeholder="seuemail@exemplo.com" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                            <input type="password" id="password" name="password" placeholder="********" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        </div>
                        <button type="button" id="login-button" class="w-full btn-primary font-semibold py-2 px-4 rounded-md text-lg">Entrar</button>
                        <div class="text-center mt-4">
                            <a href="#" class="text-sm text-green-600 hover:underline">Esqueceu a senha?</a>
                        </div>
                        <div class="text-center mt-2">
                            <span class="text-sm text-gray-600">N√£o tem uma conta? </span><a href="#" id="register-link" class="text-sm text-green-600 hover:underline">Crie uma aqui.</a>
                        </div>
                        <div id="login-message" class="text-center mt-4 text-sm font-medium"></div>
                    </form>
                </div>
            </section>

            <section id="inicio" class="p-6">
                <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Painel Principal AGROPEC</h2>
                    <p class="mt-2 text-gray-600">Bem-vindo ao aplicativo oficial da AGROPEC 2025! Explore as √∫ltimas not√≠cias, palestras em destaque e informa√ß√µes importantes sobre o evento.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-2 text-green-700">üêÑ Pr√≥xima Palestra Imperd√≠vel</h3>
                        <p class="text-gray-600 mb-1"><span class="font-medium">T√≠tulo:</span> Inova√ß√µes na Pecu√°ria Sustent√°vel</p>
                        <p class="text-600 mb-1"><span class="font-medium">Palestrante:</span> Dr. Jo√£o Silva</p>
                        <p class="text-600 mb-3"><span class="font-medium">Hor√°rio:</span> Hoje, 14:00 - Audit√≥rio Principal</p>
                        <button class="btn-accent text-sm py-2 px-3 rounded-md">Ver Detalhes</button>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-2 text-green-700">üì∞ Not√≠cias Recentes</h3>
                        <p class="text-gray-600 mb-1">AGROPEC 2025 bate recorde de expositores.</p>
                        <p class="text-gray-600 mb-3">Novas tecnologias agr√≠colas em demonstra√ß√£o.</p>
                        <button class="btn-accent text-sm py-2 px-3 rounded-md">Ler Mais</button>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-2 text-green-700">‚≠ê Meus Favoritos</h3>
                        <p class="text-gray-600">Voc√™ ainda n√£o marcou nenhum favorito.</p>
                        <p class="text-600 mb-3">Navegue pela agenda e expositores para adicionar.</p>
                         <button onclick="window.showSection('agenda', document.querySelector('a[href=\'#agenda\']'))" class="btn-accent text-sm py-2 px-3 rounded-md">Ver Agenda</button>
                    </div>
                </div>

                <div class="card p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">üì¢ Banner Principal</h3>
                    <div class="bg-green-600 text-white p-8 rounded-lg text-center">
                        <h4 class="text-2xl font-bold mb-2">AGROPEC 2025 - O Futuro do Campo √© Agora!</h4>
                        <p class="text-lg">Participe da maior exposi√ß√£o de produtos do campo. Inova√ß√£o, tecnologia e neg√≥cios em um s√≥ lugar.</p>
                    </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Acesso R√°pido</h3>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="window.showSection('agenda', document.querySelector('a[href=\'#agenda\']'))" class="btn-primary py-3 px-4 rounded-md text-center">Ver Agenda Completa</button>
                        <button onclick="window.showSection('expositores', document.querySelector('a[href=\'#expositores\']'))" class="btn-primary py-3 px-4 rounded-md text-center">Encontrar Expositores</button>
                        <button onclick="window.showSection('mapa', document.querySelector('a[href=\'#mapa\']'))" class="btn-primary py-3 px-4 rounded-md text-center">Explorar o Mapa</button>
                         <button class="btn-primary py-3 px-4 rounded-md text-center">Fale Conosco</button>
                    </div>
                </div>
            </section>

            <section id="agenda" class="p-6">
                 <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Agenda AGROPEC 2025</h2>
                    <p class="mt-2 text-gray-600">Confira a programa√ß√£o completa de palestras, workshops e demonstra√ß√µes. Planeje seu dia e n√£o perca nada!</p>
                </div>

                <div class="mb-6 card p-4">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Filtrar Eventos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="eventDate" class="block text-sm font-medium text-gray-700">Data:</label>
                            <input type="date" id="eventDate" name="eventDate" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="eventType" class="block text-sm font-medium text-gray-700">Tipo:</label>
                            <select id="eventType" name="eventType" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                                <option>Todos</option>
                                <option>Palestras</option>
                                <option>Workshops</option>
                                <option>Demonstra√ß√µes</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button class="btn-primary w-full py-2 px-4 rounded-md">Aplicar Filtros</button>
                        </div>
                    </div>
                </div>

                <div id="agenda-events-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="card p-6">
                        <h4 class="font-semibold text-lg mb-1 text-green-600">Carregando Eventos...</h4>
                        <p class="text-sm text-gray-500 mb-2">Aguarde enquanto os dados s√£o carregados do Firebase.</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-center text-green-700">Eventos por Dia</h3>
                    <div class="chart-container">
                        <canvas id="agendaChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="expositores" class="p-6">
                <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Expositores AGROPEC 2025</h2>
                    <p class="mt-2 text-gray-600">Conhe√ßa as empresas e institui√ß√µes que est√£o apresentando suas novidades e solu√ß√µes para o agroneg√≥cio.</p>
                </div>

                <div class="mb-6 card p-4">
                    <label for="searchExpositor" class="block text-sm font-medium text-gray-700">Buscar Expositor:</label>
                    <input type="text" id="searchExpositor" name="searchExpositor" placeholder="Nome do expositor ou produto..." class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                </div>

                <div id="expositores-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="card p-6 text-center">
                        <img src="https://placehold.co/100x100/388E3C/FFFFFF?text=Logo&font=Inter" alt="Logo Expositor Simulado" class="mx-auto mb-3 rounded-full h-24 w-24 object-cover border-2 border-green-500">
                        <h4 class="font-semibold text-lg text-green-600">Carregando Expositores...</h4>
                        <p class="text-sm text-gray-500 mb-2">Aguarde enquanto os dados s√£o carregados do Firebase.</p>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-center text-green-700">Expositores por Categoria</h3>
                     <div class="chart-container">
                        <canvas id="expositoresChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="mapa" class="p-6">
                <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Mapa do Evento AGROPEC 2025</h2>
                    <p class="mt-2 text-gray-600">Navegue pelo mapa interativo para encontrar estandes, audit√≥rios, pra√ßa de alimenta√ß√£o e outros pontos de interesse. O mapa √© atualizado em tempo real com as √∫ltimas informa√ß√µes!</p>
                </div>
                <div class="card p-6">
                    <canvas id="fairMapCanvas" class="map-canvas"></canvas>
                    <p class="text-center mt-4 text-gray-500">Este √© o mapa da feira. Administradores podem adicionar estandes clicando neste mapa na se√ß√£o de administra√ß√£o.</p>
                </div>
            </section>

            <section id="admin-dashboard" class="p-6">
                <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Painel Administrativo</h2>
                    <p class="mt-2 text-gray-600">Gerencie as informa√ß√µes da feira e monitore as localiza√ß√µes dos estandes.</p>
                    <p id="admin-user-role-display" class="text-sm text-gray-500 mt-2"></p> </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-700">Gerenciar Tendas/Expositores</h3>
                        <form id="tent-form" class="space-y-4">
                            <div>
                                <label for="tentName" class="block text-sm font-medium text-gray-700">Nome da Tenda/Expositor</label>
                                <input type="text" id="tentName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Ex: AgroTech Solutions" required>
                            </div>
                            <div>
                                <label for="tentCategory" class="block text-sm font-medium text-gray-700">Categoria</label>
                                <input type="text" id="tentCategory" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Ex: Pecu√°ria, Agricultura, M√°quinas">
                            </div>
                            <div>
                                <label for="tentDescription" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label>
                                <textarea id="tentDescription" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Breve descri√ß√£o da tenda e seus produtos/servi√ßos"></textarea>
                            </div>
                            <button type="submit" class="btn-primary py-2 px-4 rounded-md">Salvar Informa√ß√µes da Tenda</button>
                            <div id="tent-message" class="text-sm mt-2"></div>
                        </form>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-green-700">Adicionar Localiza√ß√£o de Estante</h3>
                        <p class="text-gray-600 mb-4">Clique no mapa abaixo para selecionar as coordenadas da estande.</p>
                        <canvas id="adminMapCanvas" class="map-canvas"></canvas> <form id="location-form" class="space-y-4">
                            <div>
                                <label for="standId" class="block text-sm font-medium text-gray-700">ID do Estante</label>
                                <input type="text" id="standId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Ex: A-01, Setor B" required>
                            </div>
                            <div>
                                <label for="standOccupant" class="block text-sm font-medium text-gray-700">Ocupante do Estante</label>
                                <input type="text" id="standOccupant" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" placeholder="Nome da Tenda/Expositor">
                            </div>
                            <div>
                                <label for="standCoordinatesDisplay" class="block text-sm font-medium text-gray-700">Coordenadas Selecionadas (Clique no mapa)</label>
                                <input type="text" id="standCoordinatesDisplay" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50" readonly placeholder="Clique no mapa para selecionar">
                                <input type="hidden" id="standX">
                                <input type="hidden" id="standY">
                            </div>
                            <button type="submit" class="btn-primary py-2 px-4 rounded-md">Salvar Localiza√ß√£o</button>
                            <div id="location-message" class="text-sm mt-2"></div>
                        </form>
                    </div>
                </div>

                <div class="card p-6 mt-6">
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Estandes Cadastradas</h3>
                    <div id="registered-stands-display" class="space-y-2 text-gray-700">
                        <p>Nenhuma estande cadastrada ainda.</p>
                    </div>
                </div>
            </section>

            <section id="stand-details" class="p-6">
                <div class="mb-6">
                    <h2 class="text-3xl font-semibold text-gray-800">Detalhes da Estande</h2>
                    <p class="mt-2 text-gray-600">Informa√ß√µes detalhadas sobre a estande.</p>
                </div>
                <div class="card p-6">
                    <div id="stand-details-content">
                        <p class="text-gray-500">Carregando detalhes da estande...</p>
                    </div>
                    <button onclick="window.history.back()" class="btn-primary py-2 px-4 rounded-md mt-6">Voltar</button>
                </div>
            </section>
        </main>
    </div>

    <div id="qrCodeModal" class="qr-modal flex">
        <div class="qr-modal-content">
            <span class="qr-modal-close">&times;</span>
            <div id="qrcode" class="flex justify-center mb-4"></div>
            </div>
    </div>
    <div id="firebase-error-message" class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-md shadow-lg hidden">
        Ocorreu um erro ao carregar o Firebase. Por favor, verifique sua conex√£o ou tente novamente. Detalhes: <span id="firebase-error-details"></span>
    </div>

    <script type="module">
        // Importa as fun√ß√µes necess√°rias do SDK do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
        // Importa createUserWithEmailAndPassword para registro
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        // Sua configura√ß√£o do Firebase (atualizada com base na sua √∫ltima mensagem)
        const firebaseConfig = {
            apiKey: "AIzaSyBLeqJsQdDVYX2zKlcs9tGzdgYsvYFDog4",
            authDomain: "agropec-2025-app.firebaseapp.com",
            projectId: "agropec-2025-app",
            storageBucket: "agropec-2025-app.firebasestorage.app",
            messagingSenderId: "203743696437",
            appId: "1:203743696437:web:0332c09896cc34eb14437c",
            measurementId: "G-40JHQ2RPEQ"
        };

        let currentUserId = null;
        let registrationContext = 'visitor'; // 'visitor' ou 'admin'

        const userIdDisplay = document.getElementById('user-id-display');
        const sidebar = document.querySelector('.sidebar');
        const logoutButton = document.getElementById('logout-button');
        const adminDashboardLink = document.getElementById('admin-dashboard-link');
        const adminUserRoleDisplay = document.getElementById('admin-user-role-display'); 
        const firebaseErrorMessage = document.getElementById('firebase-error-message');
        const firebaseErrorDetails = document.getElementById('firebase-error-details');

        // Vari√°veis do Mapa
        let fairMapCanvas;
        let fairMapCtx;
        let adminMapCanvas;
        let adminMapCtx;
        let stands = []; // Array para armazenar as estandes cadastradas

        // Fun√ß√£o para exibir/ocultar se√ß√µes (tornada explicitamente global)
        window.showSection = function(sectionId, clickedLink) {
            console.log(`Attempting to show section: ${sectionId}`);
            const sections = document.querySelectorAll('.main-content section');
            const navLinks = document.querySelectorAll('.nav-link');
            const currentSectionTitle = document.getElementById('currentSectionTitle');

            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === sectionId) {
                    section.classList.add('active');
                    let title = sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
                    if (sectionId === 'inicio') title = 'Painel Principal';
                    else if (sectionId === 'admin-dashboard') title = 'Painel Administrativo';
                    else if (sectionId === 'stand-details') title = 'Detalhes da Estande';
                    else if (sectionId === 'welcome-role-selection') title = 'Bem-vindo!';
                    currentSectionTitle.textContent = title;
                }
            });
            navLinks.forEach(link => {
                link.classList.remove('active');
                link.classList.remove('bg-green-500'); // Tailwind active class
            });
            if (clickedLink) {
                clickedLink.classList.add('active');
                clickedLink.classList.add('bg-green-500'); // Tailwind active class
            }
            // Close mobile sidebar after navigation
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        // Fun√ß√£o para inicializar um mapa espec√≠fico
        function initMap(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas com ID '${canvasId}' n√£o encontrado.`);
                return;
            }

            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 400; // Altura fixa para o mapa

            // Armazena as refer√™ncias globais
            if (canvasId === 'fairMapCanvas') {
                fairMapCanvas = canvas;
                fairMapCtx = ctx;
            } else if (canvasId === 'adminMapCanvas') {
                adminMapCanvas = canvas;
                adminMapCtx = ctx;
            }

            // Adiciona o listener de clique apenas para o mapa do admin
            if (canvasId === 'adminMapCanvas') {
                canvas.removeEventListener('click', handleMapClick); // Remove para evitar m√∫ltiplos listeners
                canvas.addEventListener('click', handleMapClick);
            } else {
                canvas.removeEventListener('click', handleMapClick); // Garante que o mapa do visitante n√£o tenha listener de clique
            }

            // Redesenha o mapa ao redimensionar a janela
            // Remove listener antigo para evitar duplica√ß√£o
            window.removeEventListener('resize', () => handleMapResize(canvasId));
            window.addEventListener('resize', () => handleMapResize(canvasId));

            // Desenha o mapa inicialmente
            drawMap(canvasId, ctx);

            // Carrega as localiza√ß√µes existentes (chamado uma vez e atualizado via onSnapshot)
            if (window.db) { // Verifica se o Firebase Firestore est√° inicializado
                loadPublicLocations();
            }
        }

        function handleMapResize(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                canvas.width = canvas.offsetWidth;
                drawMap(canvasId, canvas.getContext('2d'));
            }
        }

        // Fun√ß√£o para desenhar o mapa e as estandes em um contexto espec√≠fico
        function drawMap(canvasId, ctx) {
            console.log(`[drawMap] Starting for canvasId: ${canvasId}`);
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`[drawMap] Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            // Garante que as dimens√µes do canvas estejam corretas
            canvas.width = canvas.offsetWidth;
            canvas.height = 400; // Altura fixa conforme requisito
            console.log(`[drawMap] Canvas ${canvasId} offsetWidth: ${canvas.offsetWidth}, offsetHeight: ${canvas.offsetHeight}`);

            if (!ctx) {
                console.error(`[drawMap] Context for ${canvasId} is null or undefined.`);
                return;
            }

            // Limpa o canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            console.log(`[drawMap] Canvas ${canvasId} cleared. Dimensions: ${canvas.width}x${canvas.height}`);

            // Fundo do mapa - Usando uma cor bem vis√≠vel para depura√ß√£o
            ctx.fillStyle = '#FF00FF'; // Magenta para depura√ß√£o
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            console.log(`[drawMap] Canvas ${canvasId} filled with background color.`);

            // Desenha um ret√¢ngulo de teste proeminente
            ctx.fillStyle = '#FF0000'; // Vermelho
            ctx.fillRect(50, 50, 100, 100);
            console.log(`[drawMap] Test red rectangle drawn for ${canvasId}.`);

            // Desenha estradas (cinza escuro)
            ctx.fillStyle = '#616161'; // Cinza escuro para estradas
            const mainStreetWidth = 80;
            const mainStreetX = canvas.width / 2 - mainStreetWidth / 2;
            ctx.fillRect(mainStreetX, 0, mainStreetWidth, canvas.height);
            const crossStreetHeight = 60;
            const crossStreetY = canvas.height / 2 - crossStreetHeight / 2;
            ctx.fillRect(0, crossStreetY, canvas.width, crossStreetHeight);
            console.log(`[drawMap] Roads drawn for ${canvasId}.`);

            // Linhas tracejadas para estradas (branco)
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 10]); // Padr√£o de linha tracejada

            // Linhas tracejadas da estrada vertical principal
            ctx.beginPath();
            ctx.moveTo(mainStreetX + mainStreetWidth / 4, 0);
            ctx.lineTo(mainStreetX + mainStreetWidth / 4, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(mainStreetX + mainStreetWidth * 3 / 4, 0);
            ctx.lineTo(mainStreetX + mainStreetWidth * 3 / 4, canvas.height);
            ctx.stroke();

            // Linhas tracejadas da estrada horizontal
            ctx.beginPath();
            ctx.moveTo(0, crossStreetY + crossStreetHeight / 4);
            ctx.lineTo(canvas.width, crossStreetY + crossStreetHeight / 4);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, crossStreetY + crossStreetHeight * 3 / 4);
            ctx.lineTo(canvas.width, crossStreetY + crossStreetHeight * 3 / 4);
            ctx.stroke();

            ctx.setLineDash([]); // Resetar padr√£o de linha
            console.log(`[drawMap] Dashed lines drawn for ${canvasId}.`);

            // Desenha √°reas verdes (parques/campos)
            ctx.fillStyle = '#8BC34A'; // Verde para parques
            ctx.fillRect(20, 20, 120, 100); // Parque 1 (superior-esquerdo)
            ctx.fillRect(canvas.width - 140, canvas.height - 120, 120, 100); // Parque 2 (inferior-direito)
            ctx.fillRect(20, canvas.height - 120, 120, 100); // Parque 3 (inferior-esquerdo)
            ctx.fillRect(canvas.width - 140, 20, 120, 100); // Parque 4 (superior-direito)
            console.log(`[drawMap] Green areas drawn for ${canvasId}.`);

            // Desenha √°reas de constru√ß√£o (cinza claro/marrom) - Posi√ß√µes ajustadas para evitar estradas
            ctx.fillStyle = '#B0BEC5'; // Cinza claro para constru√ß√µes
            ctx.fillRect(160, 30, 80, 70); // Constru√ß√£o 1 (superior-esquerda, perto da estrada vertical)
            ctx.fillRect(canvas.width - 240, 100, 90, 70); // Constru√ß√£o 2 (superior-direita)
            ctx.fillStyle = '#D7CCC8'; // Marrom claro para outras constru√ß√µes
            ctx.fillRect(50, canvas.height - 170, 70, 60); // Constru√ß√£o 3 (inferior-esquerda)
            ctx.fillRect(canvas.width - 100, 240, 60, 50); // Constru√ß√£o 4 (inferior-direita)
            console.log(`[drawMap] Buildings drawn for ${canvasId}.`);

            // Desenha um grid fict√≠cio (opcional, pode ser removido para um visual mais limpo)
            ctx.strokeStyle = '#E0E0E0'; // Cor do grid mais clara
            ctx.lineWidth = 0.5;
            const gridSize = 50; // Tamanho de cada c√©lula do grid

            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y); // CORRIGIDO: Era ctx.lineTo(0, canvas.width);
                ctx.stroke();
            }
            console.log(`[drawMap] Grid drawn for ${canvasId}.`);

            // Desenha as estandes
            stands.forEach(stand => {
                ctx.fillStyle = '#4CAF50'; // Cor da estande (verde forte para destaque)
                ctx.strokeStyle = '#388E3C'; // Borda da estande
                ctx.lineWidth = 2;

                const standSize = 20; // Tamanho da estande (quadrado)
                const halfSize = standSize / 2;

                // Desenha o quadrado da estande
                ctx.fillRect(stand.x - halfSize, stand.y - halfSize, standSize, standSize);
                ctx.strokeRect(stand.x - halfSize, stand.y - halfSize, standSize, standSize);

                // Desenha o ID da estande
                ctx.fillStyle = '#FFFFFF'; // Cor do texto
                ctx.font = 'bold 10px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(stand.id, stand.x, stand.y);

                // Desenha o ocupante (nome da tenda/expositor) abaixo
                if (stand.occupant) {
                    ctx.fillStyle = '#424242'; // Cor do texto
                    ctx.font = '8px Inter';
                    ctx.fillText(stand.occupant, stand.x, stand.y + halfSize + 8);
                }
            });
            console.log(`[drawMap] Stands drawn for ${canvasId}. Total stands: ${stands.length}`);
        }

        // Fun√ß√£o para lidar com o clique no mapa (apenas para o mapa do admin)
        function handleMapClick(event) {
            const currentActiveSection = document.querySelector('.main-content section.active');
            if (currentActiveSection && currentActiveSection.id === 'admin-dashboard') {
                const rect = adminMapCanvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                document.getElementById('standX').value = Math.round(x);
                document.getElementById('standY').value = Math.round(y);
                document.getElementById('standCoordinatesDisplay').value = `X: ${Math.round(x)}, Y: ${Math.round(y)}`;

                // Opcional: Desenhar um ponto tempor√°rio no clique para feedback visual no mapa do admin
                drawMap('adminMapCanvas', adminMapCtx); // Redesenha para limpar o ponto anterior
                adminMapCtx.fillStyle = 'red';
                adminMapCtx.beginPath();
                adminMapCtx.arc(x, y, 5, 0, Math.PI * 2);
                adminMapCtx.fill();
            }
        }

        // Fun√ß√£o para exibir dados coletados (agora mostra as estandes do array 'stands')
        function displayCollectedData() {
            const displayArea = document.getElementById('registered-stands-display');
            if (!displayArea) return;

            displayArea.innerHTML = ''; // Limpa a √°rea
            if (stands.length === 0) {
                displayArea.innerHTML = '<p class="text-gray-500">Nenhuma estande cadastrada ainda.</p>';
            } else {
                const ul = document.createElement('ul');
                stands.forEach(stand => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'items-center', 'justify-between', 'py-2', 'border-b', 'border-gray-200');
                    li.innerHTML = `
                        <span>ID: ${stand.id || 'N/A'}, Ocupante: ${stand.occupant || 'N/A'}, Coords: (${stand.x || 'N/A'}, ${stand.y || 'N/A'})</span>
                        <button class="btn-accent text-sm py-1 px-2 rounded-md generate-qr-btn" data-stand-doc-id="${stand.docId}">Gerar QR Code</button>
                    `;
                    ul.appendChild(li);
                });
                displayArea.appendChild(ul);

                // Adiciona listeners para os bot√µes de QR Code
                document.querySelectorAll('.generate-qr-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        console.log("Gerar QR Code button clicked!"); // Log para depura√ß√£o
                        const standDocId = event.target.dataset.standDocId;
                        const stand = stands.find(s => s.docId === standDocId); // Encontra a estande pelo docId
                        if (stand) {
                            generateAndShowQrCode(stand);
                        } else {
                            console.error("Estande n√£o encontrada para gerar QR Code.");
                        }
                    });
                });
            }
        }

        // Fun√ß√£o para gerar e exibir o QR Code em um modal
        function generateAndShowQrCode(stand) {
            const qrCodeModal = document.getElementById('qrCodeModal');
            const qrcodeDiv = document.getElementById('qrcode');

            // Limpa qualquer QR Code anterior
            qrcodeDiv.innerHTML = '';

            // Conte√∫do do QR Code ser√° a URL para a p√°gina de detalhes da estande
            // Usamos window.location.origin para garantir que a URL seja correta para o ambiente atual
            const standDetailsUrl = `${window.location.origin}/#stand-details?id=${stand.id}`; // Usando stand.id para a URL

            // Cria o QR Code
            const qr = new window.QRCode(qrcodeDiv, { // Alterado para window.QRCode
                text: standDetailsUrl,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : window.QRCode.CorrectLevel.H // Alterado para window.QRCode.CorrectLevel.H
            });

            // Exibe o modal
            qrCodeModal.style.display = 'flex';
        }

        // Fecha o modal do QR Code
        document.querySelector('.qr-modal-close').addEventListener('click', () => {
            console.log("QR Code modal close button clicked!"); // Log para depura√ß√£o
            document.getElementById('qrCodeModal').style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            const qrCodeModal = document.getElementById('qrCodeModal');
            if (event.target === qrCodeModal) {
                console.log("Clicked outside QR Code modal!"); // Log para depura√ß√£o
                qrCodeModal.style.display = 'none';
            }
        });

        // Implementa√ß√µes Chart.js
        let agendaChartInstance = null;
        let expositoresChartInstance = null;

        function updateAgendaChart(events) {
            const days = {};
            const eventTypes = ['Palestras', 'Workshops', 'Demonstra√ß√µes', 'Outros'];

            events.forEach(event => {
                const date = event.date || 'Data Desconhecida';
                const type = event.type || 'Outros';
                if (!days[date]) {
                    days[date] = {};
                    eventTypes.forEach(t => days[date][t] = 0);
                }
                if (days[date][type] !== undefined) {
                    days[date][type]++;
                } else {
                    days[date]['Outros']++;
                }
            });

            const sortedDates = Object.keys(days).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/').map(Number);
                const [dayB, monthB, yearB] = b.split('/').map(Number);
                const dateA = new Date(yearA, monthA - 1, dayA);
                const dateB = new Date(yearB, monthB - 1, dayB);
                return dateA - dateB;
            });

            const datasets = eventTypes.map(type => {
                let backgroundColor;
                let borderColor;
                if (type === 'Palestras') {
                    backgroundColor = 'rgba(76, 175, 80, 0.7)';
                    borderColor = 'rgba(76, 175, 80, 1)';
                } else if (type === 'Workshops') {
                    backgroundColor = 'rgba(255, 193, 7, 0.7)';
                    borderColor = 'rgba(255, 193, 7, 1)';
                } else if (type === 'Demonstra√ß√µes') {
                    backgroundColor = 'rgba(66, 66, 66, 0.7)';
                    borderColor = 'rgba(66, 66, 66, 1)';
                } else {
                    backgroundColor = 'rgba(158, 158, 158, 0.7)';
                    borderColor = 'rgba(158, 158, 158, 1)';
                }

                return {
                    label: type,
                    data: sortedDates.map(date => days[date][type] || 0),
                    backgroundColor: backgroundColor,
                    borderColor: borderColor,
                    borderWidth: 1
                };
            });

            const agendaCtx = document.getElementById('agendaChart').getContext('2d');
            if (agendaCtx) {
                if (agendaChartInstance) {
                    agendaChartInstance.destroy();
                }
                agendaChartInstance = new Chart(agendaCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#424242' }
                            },
                            x: {
                                ticks: { color: '#424242' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#424242' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y + ' eventos';
                                        }
                                        const maxLabelWidth = 16;
                                        if (label.length > maxLabelWidth) {
                                            const words = label.split(' ');
                                            let currentLine = '';
                                            const lines = [];
                                            for (const word of words) {
                                                if ((currentLine + word).length > maxLabelWidth) {
                                                    lines.push(currentLine.trim());
                                                    currentLine = '';
                                                }
                                                currentLine += word + ' ';
                                            }
                                            lines.push(currentLine.trim());
                                            return lines;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateExpositoresChart(expositores) {
            const categories = {};
            expositores.forEach(expositor => {
                const category = expositor.category || 'Outros';
                categories[category] = (categories[category] || 0) + 1;
            });

            const labels = Object.keys(categories);
            const data = labels.map(label => categories[label]);

            const expositoresCtx = document.getElementById('expositoresChart').getContext('2d');
            if (expositoresCtx) {
                if (expositoresChartInstance) {
                    expositoresChartInstance.destroy();
                }
                expositoresChartInstance = new Chart(expositoresCtx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Expositores por Categoria',
                            data: data,
                            backgroundColor: [
                                'rgba(76, 175, 80, 0.8)',
                                'rgba(56, 142, 60, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(255, 160, 0, 0.8)',
                                'rgba(158, 158, 158, 0.8)',
                                'rgba(189, 189, 189, 0.8)'
                            ],
                            borderColor: '#FFFFFF',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#424242' }
                            },
                            tooltip: {
                                 callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            const total = context.dataset.data.reduce((acc, value) => acc + value, 0);
                                            const percentage = ((context.parsed / total) * 100).toFixed(1) + '%';
                                            label += percentage;
                                        }
                                        const maxLabelWidth = 16;
                                        if (label.length > maxLabelWidth) {
                                            const words = label.split(' ');
                                            let currentLine = '';
                                            const lines = [];
                                            for (const word of words) {
                                                if ((currentLine + word).length > maxLabelWidth) {
                                                    lines.push(currentLine.trim());
                                                    currentLine = '';
                                                }
                                                currentLine += word + ' ';
                                            }
                                            lines.push(currentLine.trim());
                                            return lines;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Fun√ß√µes que interagem com o Firebase, agora fora do escopo do DOMContentLoaded
        // para serem acess√≠veis globalmente.

        async function loadPublicEvents() {
            if (!currentUserId || !window.db) {
                console.log("Aguardando autentica√ß√£o ou inicializa√ß√£o do Firebase para carregar eventos.");
                return;
            }
            const eventsCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/events`);
            onSnapshot(eventsCollectionRef, (snapshot) => {
                const events = [];
                snapshot.forEach((doc) => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                console.log("Eventos carregados:", events);

                const agendaEventsContainer = document.getElementById('agenda-events-container');
                if (agendaEventsContainer) {
                    agendaEventsContainer.innerHTML = '';
                    if (events.length === 0) {
                        agendaEventsContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Nenhum evento dispon√≠vel no momento.</p>';
                    } else {
                        events.forEach(event => {
                            const eventCard = `
                                <div class="card p-6">
                                    <h4 class="font-semibold text-lg mb-1 text-green-600">${event.title || 'T√≠tulo Indispon√≠vel'}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${event.type || 'Tipo'} | ${event.date || 'Data'}, ${event.time || 'Hor√°rio'} | ${event.location || 'Local'}</p>
                                    <p class="text-gray-700 mb-3">${event.description || 'Nenhuma descri√ß√£o dispon√≠vel.'}</p>
                                    <button class="btn-accent text-sm py-1 px-3 rounded-md">Adicionar ao Calend√°rio</button>
                                </div>
                            `;
                            agendaEventsContainer.innerHTML += eventCard;
                        });
                    }
                }
                updateAgendaChart(events);

            }, (error) => {
                console.error("Erro ao carregar eventos:", error);
                const agendaEventsContainer = document.getElementById('agenda-events-container');
                if (agendaEventsContainer) {
                    agendaEventsContainer.innerHTML = '<p class="text-center text-red-500 col-span-full">Erro ao carregar eventos. Verifique suas regras de seguran√ßa.</p>';
                }
            });
        }

        async function loadPublicExpositores() {
            if (!currentUserId || !window.db) {
                console.log("Aguardando autentica√ß√£o ou inicializa√ß√£o do Firebase para carregar expositores.");
                return;
            }
            const expositoresCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/expositores`);
            onSnapshot(expositoresCollectionRef, (snapshot) => {
                const expositores = [];
                snapshot.forEach((doc) => {
                    expositores.push({ id: doc.id, ...doc.data() });
                });
                console.log("Expositores carregados:", expositores);

                const expositoresContainer = document.getElementById('expositores-container');
                if (expositoresContainer) {
                    expositoresContainer.innerHTML = '';
                    if (expositores.length === 0) {
                            expositoresContainer.innerHTML = '<p class="text-center text-gray-500 col-span-full">Nenhum expositor dispon√≠vel no momento.</p>';
                    } else {
                        expositores.forEach(expositor => {
                            const expositorCard = `
                                <div class="card p-6 text-center">
                                    <img src="${expositor.logoUrl || 'https://placehold.co/100x100/388E3C/FFFFFF?text=Logo&font=Inter'}" alt="Logo Expositor" class="mx-auto mb-3 rounded-full h-24 w-24 object-cover border-2 border-green-500">
                                    <h4 class="font-semibold text-lg text-green-600">${expositor.name || 'Nome Indispon√≠vel'}</h4>
                                    <p class="text-sm text-gray-500 mb-2">${expositor.category || 'Categoria Indispon√≠vel'}</p>
                                    <p class="text-gray-700 text-sm mb-3">${expositor.description || 'Nenhuma descri√ß√£o dispon√≠vel.'}</p>
                                    <button class="btn-accent text-sm py-1 px-3 rounded-md">Ver Detalhes</button>
                                </div>
                            `;
                            expositoresContainer.innerHTML += expositorCard;
                        });
                    }
                }
                updateExpositoresChart(expositores);

            }, (error) => {
                console.error("Erro ao carregar expositores:", error);
                const expositoresContainer = document.getElementById('expositores-container');
                if (expositoresContainer) {
                    expositoresContainer.innerHTML = '<p class="text-center text-red-500 col-span-full">Erro ao carregar expositores. Verifique suas regras de seguran√ßa.</p>';
                }
            });
        }

        // Nova fun√ß√£o para carregar localiza√ß√µes p√∫blicas e atualizar o mapa
        async function loadPublicLocations() {
            if (!currentUserId || !window.db) {
                console.log("Aguardando autentica√ß√£o ou inicializa√ß√£o do Firebase para carregar localiza√ß√µes.");
                return;
            }
            const locationsCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/locations`);
            onSnapshot(locationsCollectionRef, (snapshot) => {
                stands = []; // Limpa o array de estandes
                snapshot.forEach((doc) => {
                    // Adiciona o doc.id como 'docId' para refer√™ncia ao gerar o QR Code
                    stands.push({ docId: doc.id, ...doc.data() });
                });
                console.log("Localiza√ß√µes carregadas:", stands);

                // Redesenha ambos os mapas
                if (fairMapCanvas && fairMapCtx) {
                    drawMap('fairMapCanvas', fairMapCtx);
                }
                if (adminMapCanvas && adminMapCtx) {
                    drawMap('adminMapCanvas', adminMapCtx);
                }
                
                displayCollectedData(); // Atualiza a lista de dados coletados

                // Se n√£o houver estandes, adicione alguns dados fict√≠cios
                if (stands.length === 0) {
                    seedInitialMapData();
                }
            }, (error) => {
                console.error("Erro ao carregar localiza√ß√µes:", error);
            });
        }

        // Fun√ß√£o para adicionar dados fict√≠cios ao mapa (se estiver vazio)
        async function seedInitialMapData() {
            if (!window.db) return; // Garante que db est√° dispon√≠vel
            const locationsCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/locations`);
            const existingDocs = await getDocs(locationsCollectionRef); // Use getDocs para obter todos os documentos

            if (existingDocs.empty) {
                console.log("Adicionando dados fict√≠cios ao mapa...");
                await addDoc(locationsCollectionRef, { id: 'A1', occupant: 'AgroTech Solutions', x: 100, y: 150, description: 'Solu√ß√µes inovadoras para agricultura de precis√£o.' });
                await addDoc(locationsCollectionRef, { id: 'B3', occupant: 'Pecu√°ria Moderna', x: 300, y: 250, description: 'Tecnologias avan√ßadas para manejo de rebanhos.' });
                await addDoc(locationsCollectionRef, { id: 'C2', occupant: 'M√°quinas Agr√≠colas XYZ', x: 500, y: 100, description: 'Demonstra√ß√£o de tratores e equipamentos de √∫ltima gera√ß√£o.' });
                await addDoc(locationsCollectionRef, { id: 'D4', occupant: 'Hortali√ßas Org√¢nicas', x: 200, y: 350, description: 'Cultivo sustent√°vel e produtos frescos da horta.' });
                await addDoc(locationsCollectionRef, { id: 'E5', occupant: 'Tecnologia Rural', x: 450, y: 300, description: 'Drones e sensores para otimiza√ß√£o de lavouras.' });
            }
        }

        async function addNewExpositor(expositorData) {
            if (!currentUserId || !window.db) {
                console.log("Usu√°rio n√£o autenticado ou Firebase n√£o inicializado para adicionar expositor.");
                return;
            }
            try {
                const userExpositoresCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/expositores`); // Mudado para public/data
                await addDoc(userExpositoresCollectionRef, expositorData);
                console.log("Expositor adicionado com sucesso!");
                document.getElementById('tent-message').textContent = 'Informa√ß√µes da tenda salvas com sucesso!';
                document.getElementById('tent-message').classList.remove('text-red-500');
                document.getElementById('tent-message').classList.add('text-green-600');
                document.getElementById('tent-form').reset();
            } catch (error) {
                console.error("Erro ao adicionar expositor:", error);
                document.getElementById('tent-message').textContent = 'Erro ao salvar informa√ß√µes da tenda.';
                document.getElementById('tent-message').classList.remove('text-green-600');
                document.getElementById('tent-message').classList.add('text-red-500');
            }
        }

        async function addNewLocation(locationData) {
            if (!currentUserId || !window.db) {
                console.log("Usu√°rio n√£o autenticado ou Firebase n√£o inicializado para adicionar localiza√ß√£o.");
                return;
            }
            try {
                const locationsCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/locations`);
                // Adiciona a descri√ß√£o da tenda ao objeto de localiza√ß√£o
                const tentName = document.getElementById('standOccupant').value; // Usando o ocupante como nome da tenda para buscar a descri√ß√£o
                const expositoresCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/expositores`);
                const q = query(expositoresCollectionRef, where("name", "==", tentName));
                const querySnapshot = await getDocs(q);
                let description = '';
                if (!querySnapshot.empty) {
                    description = querySnapshot.docs[0].data().description || '';
                }

                const dataToSave = { ...locationData, description: description };
                const docRef = await addDoc(locationsCollectionRef, dataToSave);
                
                console.log("Localiza√ß√£o adicionada com sucesso com ID:", docRef.id);
                document.getElementById('location-message').textContent = 'Localiza√ß√£o salva com sucesso!';
                document.getElementById('location-message').classList.remove('text-red-500');
                document.getElementById('location-message').classList.add('text-green-600');
                document.getElementById('location-form').reset();
                document.getElementById('standCoordinatesDisplay').value = ''; // Limpa o display
                document.getElementById('standX').value = '';
                document.getElementById('standY').value = '';
                // drawMap() √© chamado via onSnapshot em loadPublicLocations()
            } catch (error) {
                console.error("Erro ao adicionar localiza√ß√£o:", error);
                document.getElementById('location-message').textContent = 'Erro ao salvar localiza√ß√£o.';
                document.getElementById('location-message').classList.remove('text-green-600');
                document.getElementById('location-message').classList.add('text-red-500');
            }
        }

        // Fun√ß√£o para carregar e exibir os detalhes de uma estande na se√ß√£o #stand-details
        async function loadStandDetails(standId) {
            const standDetailsContent = document.getElementById('stand-details-content');
            if (!standDetailsContent) return;

            standDetailsContent.innerHTML = '<p class="text-gray-500">Carregando detalhes da estande...</p>';

            try {
                if (!window.db) {
                    console.log("Firebase n√£o inicializado para carregar detalhes da estande.");
                    standDetailsContent.innerHTML = '<p class="text-red-500">Erro: Firebase n√£o inicializado.</p>';
                    return;
                }
                const locationsCollectionRef = collection(window.db, `artifacts/${firebaseConfig.appId}/public/data/locations`);
                // Precisamos encontrar o documento pelo ID da estande, n√£o pelo docId do Firestore diretamente
                // Como o 'id' da estande √© um campo, faremos uma query
                const q = query(locationsCollectionRef, where("id", "==", standId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const standDoc = querySnapshot.docs[0];
                    const standData = standDoc.data();
                    standDetailsContent.innerHTML = `
                        <h4 class="font-semibold text-2xl mb-2 text-green-700">${standData.occupant || 'Estande Sem Nome'} (ID: ${standData.id || 'N/A'})</h4>
                        <p class="text-gray-700 mb-2"><span class="font-medium">Coordenadas:</span> X: ${standData.x || 'N/A'}, Y: ${standData.y || 'N/A'}</p>
                        <p class="text-gray-700 mb-4"><span class="font-medium">Descri√ß√£o:</span> ${standData.description || 'Nenhuma descri√ß√£o dispon√≠vel para esta estande.'}</p>
                        `;
                } else {
                    standDetailsContent.innerHTML = '<p class="text-red-500">Estande n√£o encontrada.</p>';
                }
            } catch (error) {
                console.error("Erro ao carregar detalhes da estande:", error);
                standDetailsContent.innerHTML = '<p class="text-red-500">Erro ao carregar detalhes da estande. Tente novamente.</p>';
            }
        }


        async function handleRegister() {
            console.log("Register link clicked!"); // Log para depura√ß√£o
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginMessageDiv = document.getElementById('login-message');

            const email = emailInput.value.trim();
            const password = passwordInput.value; 

            loginMessageDiv.textContent = '';

            if (!email || !password) {
                if (loginMessageDiv) {
                    loginMessageDiv.textContent = "Por favor, preencha o e-mail e a senha para criar a conta.";
                    loginMessageDiv.classList.remove('text-green-600');
                    loginMessageDiv.classList.add('text-red-500');
                }
                return;
            }
            if (!window.auth || !window.db) {
                console.error("Firebase Auth ou Firestore n√£o inicializado.");
                loginMessageDiv.textContent = "Erro: Servi√ßo de autentica√ß√£o n√£o dispon√≠vel.";
                loginMessageDiv.classList.add('text-red-500');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(window.auth, email, password); 
                const user = userCredential.user;

                const userProfileDocRef = doc(window.db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/profile/details`); 
                await setDoc(userProfileDocRef, { 
                    uid: user.uid,
                    email: user.email,
                    createdAt: new Date().toISOString(),
                    role: registrationContext 
                });

                if (loginMessageDiv) {
                    loginMessageDiv.textContent = "Conta criada com sucesso! Voc√™ j√° pode entrar.";
                    loginMessageDiv.classList.remove('text-red-500');
                    loginMessageDiv.classList.add('text-green-600');
                }
                emailInput.value = '';
                passwordInput.value = '';
            } catch (error) {
                console.error("Erro ao criar conta:", error);
                let errorMessage = "Erro ao criar conta.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este e-mail j√° est√° em uso. Tente fazer login ou use outro e-mail.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha √© muito fraca. Ela deve ter pelo menos 6 caracteres.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "O formato do e-mail √© inv√°lido.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "O registro com e-mail/senha n√£o est√° habilitado. Por favor, habilite-o no console do Firebase (Authentication -> Sign-in method).";
                }
                if (loginMessageDiv) {
                    loginMessageDiv.textContent = errorMessage;
                    loginMessageDiv.classList.remove('text-green-600');
                    loginMessageDiv.classList.add('text-red-500');
                }
            }
        }

        async function handleLogin() {
            console.log("Login button clicked!"); // Log para depura√ß√£o
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginMessageDiv = document.getElementById('login-message');

            const email = emailInput.value.trim();
            const password = passwordInput.value; 

            loginMessageDiv.textContent = '';

            if (!email || !password) {
                if (loginMessageDiv) {
                    loginMessageDiv.textContent = "Por favor, preencha o e-mail e a senha para fazer login.";
                    loginMessageDiv.classList.remove('text-green-600');
                    loginMessageDiv.classList.add('text-red-500');
                }
                return;
            }
            if (!window.auth) {
                console.error("Firebase Auth n√£o inicializado.");
                loginMessageDiv.textContent = "Erro: Servi√ßo de autentica√ß√£o n√£o dispon√≠vel.";
                loginMessageDiv.classList.add('text-red-500');
                return;
            }

            try {
                await signInWithEmailAndPassword(window.auth, email, password); 
                if (loginMessageDiv) {
                    loginMessageDiv.textContent = "Login realizado com sucesso!";
                    loginMessageDiv.classList.remove('text-red-500');
                    loginMessageDiv.classList.add('text-green-600');
                }
                // onAuthStateChanged ir√° lidar com a exibi√ß√£o da sidebar e redirecionamento
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                let errorMessage = "Erro ao fazer login. Verifique seu e-mail e senha.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "E-mail ou senha inv√°lidos.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "O formato do e-mail √© inv√°lido.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "O login com e-mail/senha n√£o est√° habilitado. Por favor, habilite-o no console do Firebase (Authentication -> Sign-in method).";
                }
                if (loginMessageDiv) {
                    loginMessageDiv.textContent = errorMessage;
                    loginMessageDiv.classList.remove('text-green-600');
                    loginMessageDiv.classList.add('text-red-500');
                }
            }
        }

        async function handleVisitorLogin() {
            console.log("Visitor button clicked!"); // Log para depura√ß√£o
            if (!window.auth) {
                console.error("Firebase Auth n√£o inicializado.");
                // Pode adicionar uma mensagem de erro na UI aqui se desejar
                return;
            }
            try {
                await signInAnonymously(window.auth); 
                console.log("Login de visitante (an√¥nimo) realizado.");
                registrationContext = 'visitor'; // Garante que o contexto seja 'visitor' para login an√¥nimo
                // onAuthStateChanged ir√° lidar com a exibi√ß√£o da sidebar e redirecionamento para 'inicio'
            } catch (error) {
                console.error("Erro ao fazer login de visitante:", error);
                // Voc√™ pode adicionar uma mensagem de erro na UI se desejar
            }
        }

        async function handleLogout() {
            console.log("Logout button clicked!"); // Log para depura√ß√£o
            if (!window.auth) {
                console.error("Firebase Auth n√£o inicializado.");
                return;
            }
            try {
                await window.auth.signOut();
                console.log("Usu√°rio desconectado.");
                registrationContext = 'visitor'; // Reseta o contexto ao deslogar
            } catch (error) {
                console.error("Erro ao desconectar:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded fired.");

            // Ensure the QR code modal is hidden on load
            const qrCodeModal = document.getElementById('qrCodeModal');
            if (qrCodeModal) {
                qrCodeModal.style.display = 'none';
            }

            // Inicializar Firebase (acessando globalmente)
            let app, db, auth, analytics;
            try {
                console.log("Attempting to initialize Firebase...");
                app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app); // Inicializa analytics se necess√°rio
                db = getFirestore(app);
                auth = getAuth(app);

                // Tornar db e auth globais para acesso em outras fun√ß√µes
                window.db = db;
                window.auth = auth;
                console.log("Firebase initialized successfully.");
                firebaseErrorMessage.classList.add('hidden'); // Esconde a mensagem de erro se a inicializa√ß√£o for bem-sucedida
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                firebaseErrorDetails.textContent = error.message; // Exibe a mensagem de erro espec√≠fica
                firebaseErrorMessage.classList.remove('hidden'); // Mostra a mensagem de erro
                // Impede que o restante do script que depende do Firebase seja executado
                return; 
            }

            // Listener de autentica√ß√£o, agora dentro do DOMContentLoaded
            if (window.auth) { // Garante que auth est√° dispon√≠vel antes de adicionar o listener
                onAuthStateChanged(window.auth, async (user) => { // Use onAuthStateChanged do m√≥dulo auth
                    console.log("Auth state changed. User:", user ? user.uid : "null");
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Usu√°rio autenticado:", currentUserId);
                        if (userIdDisplay) {
                            userIdDisplay.textContent = `User ID: ${currentUserId}`;
                            userIdDisplay.classList.remove('hidden');
                        }
                        
                        sidebar.classList.remove('sidebar-initial-hidden');
                        sidebar.classList.remove('-translate-x-full');
                        logoutButton.classList.remove('hidden');

                        // Carrega dados APENAS se o Firebase estiver inicializado
                        if (window.db) {
                            loadPublicEvents();
                            loadPublicExpositores();
                            // O initMap() j√° chama loadPublicLocations()
                        }

                        // Tenta buscar o perfil do usu√°rio para determinar a role
                        let userRole = 'visitor';
                        if (window.db) { // Verifica se db est√° dispon√≠vel antes de tentar buscar o perfil
                            const userProfileDocRef = doc(window.db, `artifacts/${firebaseConfig.appId}/users/${user.uid}/profile/details`); // Use doc
                            try {
                                const userProfileSnap = await getDoc(userProfileDocRef); // Use getDoc
                                userRole = userProfileSnap.exists ? userProfileSnap.data().role : 'visitor';
                                console.log("User role:", userRole);
                            } catch (profileError) {
                                console.error("Erro ao carregar perfil do usu√°rio:", profileError);
                                // Continua como visitante em caso de erro ao carregar o perfil
                            }
                        }
                        

                        if (userRole === 'admin') {
                            adminDashboardLink.classList.remove('hidden');
                            window.showSection('admin-dashboard', document.querySelector('a[href=\'#admin-dashboard\']'));
                            if (adminUserRoleDisplay) {
                                adminUserRoleDisplay.textContent = `Voc√™ est√° logado como: Administrador (${user.email || 'N/A'})`;
                            }
                        } else {
                            adminDashboardLink.classList.add('hidden');
                            // Verifica se a URL j√° cont√©m um hash para stand-details
                            const hash = window.location.hash;
                            if (hash.startsWith('#stand-details?id=')) {
                                const standId = hash.split('id=')[1];
                                window.showSection('stand-details', null); // N√£o h√° link de navega√ß√£o para esta se√ß√£o
                                loadStandDetails(standId);
                            } else if (hash === '' || hash === '#login' || hash === '#welcome-role-selection' || hash === '#admin-dashboard') {
                                window.showSection('inicio', document.querySelector('a[href=\'#inicio\']'));
                            } else {
                                const currentHashSection = hash.substring(1);
                                const currentNavLink = document.querySelector(`a[href="#${currentHashSection}"]`);
                                if (currentNavLink) {
                                    window.showSection(currentHashSection, currentNavLink);
                                } else {
                                    window.showSection('inicio', document.querySelector('a[href=\'#inicio\']'));
                                }
                            }
                            if (adminUserRoleDisplay) { 
                                adminUserRoleDisplay.textContent = '';
                            }
                        }

                    } else {
                        currentUserId = null;
                        console.log("Nenhum usu√°rio autenticado.");
                        if (userIdDisplay) {
                            userIdDisplay.textContent = '';
                            userIdDisplay.classList.add('hidden');
                        }
                        sidebar.classList.add('sidebar-initial-hidden');
                        sidebar.classList.add('-translate-x-full');
                        logoutButton.classList.add('hidden');
                        adminDashboardLink.classList.add('hidden');
                        if (adminUserRoleDisplay) { 
                            adminUserRoleDisplay.textContent = '';
                        }

                        // Se deslogado, verifica se a URL √© de detalhes de estande para exibir
                        const hash = window.location.hash;
                        if (hash.startsWith('#stand-details?id=')) {
                            const standId = hash.split('id=')[1];
                            window.showSection('stand-details', null);
                            loadStandDetails(standId);
                        } else {
                            window.showSection('welcome-role-selection', null);
                        }
                    }
                });
            } else {
                console.error("Firebase Auth n√£o foi inicializado, onAuthStateChanged n√£o ser√° anexado.");
                firebaseErrorDetails.textContent = "Firebase Auth n√£o p√¥de ser inicializado. Verifique os scripts CDN.";
                firebaseErrorMessage.classList.remove('hidden');
            }


            // Restante dos listeners de evento DOMContentLoaded
            const registerLink = document.getElementById('register-link');
            if (registerLink) {
                registerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Register link clicked!"); // Log para depura√ß√£o
                    handleRegister();
                });
            }

            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Login button clicked!"); // Log para depura√ß√£o
                    handleLogin();
                });
            }

            const visitorButton = document.getElementById('visitor-button');
            if (visitorButton) {
                visitorButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Visitor button clicked!"); // Log para depura√ß√£o
                    registrationContext = 'visitor'; // Define o contexto para visitante
                    handleVisitorLogin();
                });
            }

            const adminButton = document.getElementById('admin-button');
            if (adminButton) {
                adminButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Admin button clicked!"); // Log para depura√ß√£o
                    registrationContext = 'admin'; // Define o contexto para administrador
                    window.showSection('login', document.querySelector('a[href=\'#login\']'));
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }

            const tentForm = document.getElementById('tent-form');
            if (tentForm) {
                tentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Tent form submitted!"); // Log para depura√ß√£o
                    const tentName = document.getElementById('tentName').value;
                    const tentCategory = document.getElementById('tentCategory').value;
                    const tentDescription = document.getElementById('tentDescription').value;
                    await addNewExpositor({ name: tentName, category: tentCategory, description: tentDescription });
                });
            }

            const locationForm = document.getElementById('location-form');
            if (locationForm) {
                locationForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    console.log("Location form submitted!"); // Log para depura√ß√£o
                    const standId = document.getElementById('standId').value;
                    const standOccupant = document.getElementById('standOccupant').value;
                    const standX = parseInt(document.getElementById('standX').value, 10);
                    const standY = parseInt(document.getElementById('standY').value, 10);

                    if (isNaN(standX) || isNaN(standY)) {
                        document.getElementById('location-message').textContent = 'Por favor, clique no mapa para selecionar as coordenadas da estande.';
                        document.getElementById('location-message').classList.remove('text-green-600');
                        document.getElementById('location-message').classList.add('text-red-500');
                        return;
                    }
                    await addNewLocation({ id: standId, occupant: standOccupant, x: standX, y: standY });
                });
            }

            window.addEventListener('hashchange', () => {
                console.log("Hash changed to:", window.location.hash);
                const hash = window.location.hash;
                if (hash.startsWith('#stand-details?id=')) {
                    const standId = hash.split('id=')[1];
                    window.showSection('stand-details', null);
                    loadStandDetails(standId);
                } else {
                    const newSection = hash ? hash.substring(1) : 'welcome-role-selection';
                    const newLink = document.querySelector(`.nav-link[href="#${newSection}"]`);
                    window.showSection(newSection, newLink);
                }
            });

            // Verifica a hash na carga inicial da p√°gina
            const initialHash = window.location.hash;
            if (initialHash.startsWith('#stand-details?id=')) {
                const standId = initialHash.split('id=')[1];
                window.showSection('stand-details', null);
                loadStandDetails(standId);
            } else {
                 // Define a se√ß√£o inicial com base no hash ou padr√£o
                const initialSectionId = initialHash ? initialHash.substring(1) : 'welcome-role-selection';
                const initialNavLink = document.querySelector(`.nav-link[href="#${initialSectionId}"]`);
                window.showSection(initialSectionId, initialNavLink);
            }
        });

        // Inicializa os mapas quando a janela estiver totalmente carregada
        window.onload = function() {
            console.log("Window loaded. Initializing maps.");
            initMap('fairMapCanvas');
            initMap('adminMapCanvas');
        };
    </script>
</body>
</html>
